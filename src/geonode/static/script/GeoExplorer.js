/*
Copyright (c) 2008-2009, OpenGeo
All rights reserved.

Redistribution and use in source and binary forms, with or without
modification, are permitted provided that the following conditions are met:

    * Redistributions of source code must retain the above copyright notice,
      this list of conditions and the following disclaimer.
    * Redistributions in binary form must reproduce the above copyright
      notice, this list of conditions and the following disclaimer in the
      documentation and/or other materials provided with the distribution.
    * Neither the name of the Open Planning Project nor the names
      of its contributors may be used to endorse or promote products derived
      from this software without specific prior written permission.

THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE
LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
POSSIBILITY OF SUCH DAMAGE.
*/

Ext.layout.Accordion.prototype.setActiveItem=function(item){item=this.container.getComponent(item);if(this.activeItem!=item){this.activeItem=item;}};Ext.layout.Accordion.prototype.renderItem=function(c){if(this.animate===false){c.animCollapse=false;}
c.collapsible=true;if(this.autoWidth){c.autoWidth=true;}
if(this.titleCollapse){c.titleCollapse=true;}
if(this.hideCollapseTool){c.hideCollapseTool=true;}
if(this.collapseFirst!==undefined){c.collapseFirst=this.collapseFirst;}
if(!this.activeItem&&!c.collapsed){this.activeItem=c;}else if(this.activeItem!=c){c.collapsed=true;}
Ext.layout.Accordion.superclass.renderItem.apply(this,arguments);c.header.addClass('x-accordion-hd');c.on('beforeexpand',this.beforeExpand,this);};var GeoExplorer=Ext.extend(Ext.util.Observable,{map:null,layers:null,capabilities:null,mapPanel:null,toolbar:null,alignToGrid:false,capGrid:null,popupCache:null,layerSources:null,zoomSliderTipText:"UT: Zoom Level",addLayersButtonText:"UT:Add Layers",removeLayerActionText:"UT:Remove Layer",zoomToLayerExtentText:"UT:Zoom to Layer Extent",removeLayerActionTipText:"UT:Remove Layer",layerContainerText:"UT:Map Layers",layersPanelText:"UT:Layers",layersContainerText:"UT:Data",legendPanelText:"UT:Legend",capGridText:"UT:Available Layers",capGridAddLayersText:"UT:Add Layers",capGridDoneText:"UT:Done",zoomSelectorText:'UT:Zoom level',navActionTipText:"UT:Pan Map",navPreviousActionText:"UT:Zoom to Previous Extent",navNextAction:"UT:Zoom to Next Extent",infoButtonText:"UT:Get Feature Info",measureSplitText:"UT:Measure",areaActionText:"UT:Area",lengthActionText:"UT:Length",zoomInActionText:"UT:Zoom In",zoomOutActionText:"UT:Zoom Out",zoomVisibleButtonText:"UT:Zoom to Visible Extent",switchTo3DActionText:"UT:Switch to Google Earth 3D Viewer",publishActionText:'UT:Publish Map',metaDataHeader:'UT:About this Map',metaDataMapTitle:'UT:Title',metaDataMapContact:'UT:Contact',metaDataMapAbstract:'UT:Abstract',metaDataMapTags:'UT:Tags',metaDataMapId:"UT:Permalink",metaDataFeatured:"UT: Featured Map",saveMapText:"UT: Save Map",permalinkLabel:'UT: Permalink',noPermalinkText:"UT: This map has not yet been saved.",saveFailTitle:"UT: Error While Saving",saveFailMessage:"UT: Sorry, your map could not be saved.",layerSelectionLabel:"View available data from:",layerAdditionLabel:"or add a new server.",unknownMapTitle:'UT: Unknown Map',unknownMapMessage:'UT: The map that you are trying to load does not exist.  Creating a new map instead.',sourceLoadFailureMessage:'UT: Error contacting server.\n Please check the url and try again.',exportDialogMessage:'<p> UT: Your map is ready to be published to the web! </p>'+'<p> Simply copy the following HTML to embed the map in your website: </p>',miniSizeLabel:'UT: Mini',smallSizeLabel:'UT: Small',largeSizeLabel:'UT: Large',premiumSizeLabel:'UT: Premium',mapSizeLabel:'UT: Map Size',heightLabel:'UT: Height',widthLabel:'UT: Width',constructor:function(config){var query=Ext.urlDecode(document.location.search.substr(1));var queryConfig=Ext.util.JSON.decode(query.q);this.initialConfig=Ext.apply({},queryConfig,config);Ext.apply(this,this.initialConfig);this.addEvents(["ready","idchange"]);if(this.proxy){OpenLayers.ProxyHost=this.proxy;}
this.popupCache={};this.load();},load:function(){this.layerSources=new Ext.data.SimpleStore({fields:["identifier","name","store","url"],data:[]});var dispatchQueue=[function(done){Ext.onReady(function(){this.createLayout();done();},this);}];for(var id in this.wms){dispatchQueue.push((function(id){return function(done){this.addSource(this.wms[id],id,done,done);};})(id));}
GeoExplorer.util.dispatch(dispatchQueue,this.activate,this);},addSource:function(url,id,success,fail,scope){scope=scope||this;success=OpenLayers.Function.bind(success,scope);fail=OpenLayers.Function.bind(fail,scope);id=id||OpenLayers.Util.createUniqueID("source");var capsURL=this.createWMSCapabilitiesURL(url);var store=new GeoExt.data.WMSCapabilitiesStore();OpenLayers.Request.GET({proxy:this.proxy,url:capsURL,success:function(request){var store=new GeoExt.data.WMSCapabilitiesStore({fields:[{name:"name",type:"string"},{name:"abstract",type:"string"},{name:"queryable",type:"boolean"},{name:"formats"},{name:"styles"},{name:"llbbox"},{name:"minScale"},{name:"maxScale"},{name:"prefix"},{name:"attribution"},{name:"keywords"},{name:"metadataURLs"},{name:"owsType"},{name:"group",type:"string"},{name:"source_id",type:"string"}]});store.on("load",function(store){this.describeLayers(store,url,record,success);},this);var xml=request.responseXML;var data=(xml&&xml.documentElement)?xml:request.responseText;var format=new OpenLayers.Format.WMSCapabilities();var extractedData=format.read(data);store.on("load",function(store){store.each(function(record){record.set("source_id",id);},this);});var record=new this.layerSources.recordType({url:url,store:store,identifier:id,name:extractedData.service.title||id});this.layerSources.add(record);try{store.loadData(data);}catch(err){OpenLayers.Console.error("Could not load source: "+url);fail();return;}},failure:function(){OpenLayers.Console.error("Couldn't get capabilities document for wms '"+id+"'.");fail();},scope:this});},describeLayers:function(store,url,sourceRecord,success){var layerNames=[];store.each(function(layer){if(layer.get("queryable")){layerNames.push(layer.get("name"));}});layerNames=layerNames.join(",");OpenLayers.Request.GET({proxy:this.proxy,url:this.createOWSUrl(url,{SERVICE:"WMS",REQUEST:"DescribeLayer",VERSION:"1.1.1",layers:layerNames}),success:function(request){var describeLayerStore=new GeoExt.data.WMSDescribeLayerStore();var annotateLayers=function(describeLayerStore){describeLayerStore.each(function(description){var layer=store.getAt(store.find("name",description.get("typeName")));layer.set("owsType",description.get("owsType"));},this);success(sourceRecord);};describeLayerStore.on("load",annotateLayers,this);var xml=request.responseXML;var data=(xml&&xml.documentElement)?xml:request.responseText;describeLayerStore.loadData(data);}});},createWMSCapabilitiesURL:function(url){return this.createOWSUrl(url,{SERVICE:'WMS',REQUEST:'GetCapabilities'});},createOWSUrl:function(url,params){var argIndex=url.indexOf("?");if(argIndex>-1){var search=url.substring(url.indexOf("?")+1);url=url.replace(search,Ext.urlEncode(Ext.apply(Ext.urlDecode(search),params)));}else{url=url+"?"+Ext.urlEncode(params);}
return url;},createLayout:function(){this.map=new OpenLayers.Map({allOverlays:true,controls:[new OpenLayers.Control.Navigation(),new OpenLayers.Control.PanPanel(),new OpenLayers.Control.ZoomPanel(),new OpenLayers.Control.Attribution()]});var onDoubleClick=function(ctrl,evt){OpenLayers.Event.stop(evt?evt:window.event);};var controls=this.map.controls[1].controls;for(var i=0;i<controls.length;i++){OpenLayers.Event.observe(controls[i].panel_div,"dblclick",OpenLayers.Function.bind(onDoubleClick,this.map.controls[0],controls[i]));}
this.map.events.on({"preaddlayer":function(evt){if(evt.layer.mergeNewParams){var maxExtent=evt.layer.maxExtent;evt.layer.mergeNewParams({transparent:true,format:"image/png",tiled:true,tilesorigin:[maxExtent.left,maxExtent.bottom]});}},scope:this});var mapConfig=this.initialConfig.map||{};this.mapPanel=new GeoExt.MapPanel({layout:"anchor",border:true,map:this.map,center:mapConfig.center&&new OpenLayers.LonLat(mapConfig.center[0],mapConfig.center[1]),zoom:mapConfig.zoom,items:[{xtype:"gx_zoomslider",vertical:true,height:100,plugins:new GeoExt.ZoomSliderTip({template:"<div>"+this.zoomSliderTipText+": {zoom}<div>"})},this.createMapOverlay()]});this.layers=this.mapPanel.layers;var addLayerButton=new Ext.Button({tooltip:this.addLayersButtonText,disabled:true,iconCls:"icon-addlayers",handler:this.showCapabilitiesGrid,scope:this});this.on("ready",function(){addLayerButton.enable();});var removeLayerAction=new Ext.Action({text:this.removeLayerActionText,iconCls:"icon-removelayers",disabled:true,tooltip:this.removeLayerActionTipText,handler:function(){var node=layerTree.getSelectionModel().getSelectedNode();if(node&&node.layer){var layer=node.layer;var store=node.layerStore;var record=store.getAt(store.findBy(function(record){return record.get("layer")===layer;}));store.remove(record);removeLayerAction.disable();}}});var updateRemoveLayerAction=function(){var count=this.mapPanel.layers.queryBy(function(r){return!(r.get("layer")instanceof OpenLayers.Layer.Vector);}).getCount();if(count>1){removeLayerAction.enable();}};var layerTree=new Ext.tree.TreePanel({border:false,rootVisible:false,root:new GeoExt.tree.LayerContainer({text:this.layerContainerText,layerStore:this.layers}),enableDD:true,selModel:new Ext.tree.DefaultSelectionModel({listeners:{beforeselect:updateRemoveLayerAction,scope:this}}),listeners:{contextmenu:function(node,e){if(node&&node.layer){node.select();var c=node.getOwnerTree().contextMenu;c.contextNode=node;c.showAt(e.getXY());}},startdrag:function(tree,node,evt){node.getUI().checkbox.checked=node.attributes.checked;},scope:this},contextMenu:new Ext.menu.Menu({items:[{text:this.zoomToLayerExtentText,iconCls:"icon-zoom-visible",handler:function(){var node=layerTree.getSelectionModel().getSelectedNode();if(node&&node.layer){this.map.zoomToExtent(node.layer.restrictedExtent);}},scope:this},removeLayerAction]})});var layersContainer=new Ext.Panel({autoScroll:true,border:false,region:'center',title:this.layersContainerText,items:[layerTree],tbar:[addLayerButton,Ext.apply(new Ext.Button(removeLayerAction),{text:""})]});var legendContainer=new GeoExt.LegendPanel({title:this.legendPanelText,border:false,region:'south',height:200,collapsible:true,split:true,autoScroll:true,ascending:false,map:this.map,defaults:{cls:'legend-item'}});var titleField=new Ext.form.TextField({width:'95%',disabled:true,listeners:{'change':function(field,newValue,oldValue){this.about.title=newValue;},scope:this}});var contactField=new Ext.form.TextField({width:'95%',disabled:true,listeners:{'change':function(field,newValue,oldValue){this.about.contact=newValue;},scope:this}});var abstractField=new Ext.form.TextArea({width:'95%',disabled:true,listeners:{'change':function(field,newValue,oldValue){this.about["abstract"]=newValue;},scope:this}});var tagField=new Ext.form.TextField({width:'95%',disabled:true,listeners:{'change':function(field,newValue,oldValue){this.about.tags=newValue;},scope:this}});var linkField=new Ext.form.TextField({width:'95%',disabled:true,listeners:{scope:this}});var featuredCheck=new Ext.form.Checkbox({disabled:true,listeners:{'check':function(field,newValue,oldValue){this.about.featured=newValue;},scope:this}});var permalink=function(id){return window.location.protocol+"//"+
window.location.host+
window.location.pathname+"?"+Ext.urlEncode({map:id});};this.on("idchange",function(id){linkField.setValue(permalink(id));},this);var metaDataPanel=new Ext.FormPanel({border:false,split:true,autoScroll:true,collapsible:true,layout:new Ext.layout.ContainerLayout(),items:[new Ext.form.Label({html:this.metaDataMapTitle}),titleField,new Ext.form.Label({html:this.metaDataMapContact}),contactField,new Ext.form.Label({html:this.metaDataMapAbstract}),abstractField,new Ext.form.Label({html:this.metaDataMapTags}),tagField,new Ext.form.Label({html:this.metaDataMapId}),linkField,new Ext.form.Label({html:this.metaDataFeatured}),featuredCheck],title:this.metaDataHeader,height:250});this.on("ready",function(){titleField.setValue(this.about.title);contactField.setValue(this.about.contact);abstractField.setValue(this.about["abstract"]);tagField.setValue(this.about.tags);featuredCheck.setValue(this.about.featured);if(!this.mapID){linkField.setValue(this.noPermalinkText);}else{linkField.setValue(permalink(this.mapID));}
metaDataPanel.enable();},this);var layersTabPanel=new Ext.TabPanel({items:[layersContainer,legendContainer],activeTab:0});var layersPanel=new Ext.Panel({title:this.layersPanelText,layout:"fit",items:[layersTabPanel]});var westPanel=new Ext.Panel({border:true,layout:"accordion",layoutConfig:{titleCollapse:false,animate:true},region:"west",width:250,split:true,collapsible:true,collapseMode:"mini",activeItem:1,items:[metaDataPanel,layersPanel]});this.toolbar=new Ext.Toolbar({xtype:"toolbar",region:"north",disabled:true,items:this.createTools()});this.on("ready",function(){var disabled=this.toolbar.items.filterBy(function(item){return item.initialConfig&&item.initialConfig.disabled;});this.toolbar.enable();disabled.each(function(item){item.disable();});},this);this.googleEarthPanel=new GeoExplorer.GoogleEarthPanel({mapPanel:this.mapPanel});this.googleEarthPanel.on("show",function(){addLayerButton.disable();removeLayerAction.disable();layerTree.getSelectionModel().un("beforeselect",updateRemoveLayerAction,this);},this);this.googleEarthPanel.on("hide",function(){addLayerButton.enable();removeLayerAction.enable();layerTree.getSelectionModel().on("beforeselect",updateRemoveLayerAction,this);},this);this.mapPanelContainer=new Ext.Panel({layout:"card",region:"center",defaults:{border:false},items:[this.mapPanel,this.googleEarthPanel],activeItem:0});var viewport=new Ext.Viewport({layout:"border",items:[{region:"north",html:"<div id='app-header'>"+"<a href='#' id='spanish'></a>"+"<a href='#' id='english'></a>"+"<a id='banner' href='"+this.homeUrl+"'>"+"</div>",autoHeight:true},{region:"center",layout:"fit",hideBorders:true,height:200,items:{layout:"border",deferredRender:false,items:[this.toolbar,this.mapPanelContainer,westPanel]}}]});Lang.registerLinks();},activate:function(){if(this.mapid){this.fireevent('idchange',this.mapid);}
this.addLayers();Ext.QuickTips.init();this.fireEvent("ready");},addLayers:function(){var mapConfig=this.initialConfig.map;if(mapConfig&&mapConfig.layers){var records=[];for(var i=0;i<mapConfig.layers.length;++i){var conf=mapConfig.layers[i];var index=this.layerSources.find("identifier",conf.wms);if(index==-1){continue;}
var storeRecord=this.layerSources.getAt(index);var store=storeRecord.data.store;var id=store.find("name",conf.name);var record;var base;if(id>=0){Ext.data.Record.AUTO_ID++;record=store.getAt(id).copy(Ext.data.Record.AUTO_ID);layer=record.get("layer").clone();record.set("layer",null);record.set("layer",layer);layer.restrictedExtent=OpenLayers.Bounds.fromArray(record.get("llbbox"));if(this.alignToGrid){layer.maxExtent=new OpenLayers.Bounds(-180,-90,180,90);}else{layer.maxExtent=layer.restrictedExtent;}
layer.visibility=("visibility"in conf)?conf.visibility:true;if(conf.title){layer.setName(conf.title);record.set("title",conf.title);}
record.set("group",conf.group);if(record.get("group")==="background"){records.unshift(record);}else{records.push(record);}}}
this.layers.add(records);if(this.mapPanel.center){this.map.setCenter(this.mapPanel.center,this.mapPanel.zoom);}else if(this.mapPanel.extent){this.map.zoomToExtent(this.mapPanel.extent);}else{this.map.zoomToMaxExtent();}}},initCapGrid:function(){var firstSource=this.layerSources.getAt(0);var capGridPanel=new GeoExplorer.CapabilitiesGrid({store:firstSource.data.store,mapPanel:this.mapPanel,expander:new GeoExplorer.CapabilitiesRowExpander({ows:firstSource.get("url")}),layout:'fit',region:'center',autoScroll:true,alignToGrid:this.alignToGrid,listeners:{rowdblclick:function(panel,index,evt){panel.addLayers();}}});var sourceComboBox=new Ext.form.ComboBox({store:this.layerSources,valueField:"identifier",displayField:"name",triggerAction:"all",editable:false,allowBlank:false,forceSelection:true,mode:"local",value:firstSource.data.identifier,listeners:{select:function(combo,record,index){capGridPanel.reconfigure(record.data.store,capGridPanel.getColumnModel());capGridPanel.expander.ows=record.get("url");},scope:this}});var capGridToolbar=null;if(this.proxy||this.layerSources.getCount()>1){capGridToolbar=[new Ext.Toolbar.TextItem({text:this.layerSelectionLabel}),sourceComboBox];}
if(this.proxy){capGridToolbar.push(new Ext.Button({text:this.layerAdditionLabel,handler:function(){newSourceWindow.show();}}));}
var newSourceWindow=new GeoExplorer.NewSourceWindow({modal:true});newSourceWindow.on("server-added",function(url){newSourceWindow.setLoading();var success=function(record){var index=this.layerSources.find("identifier",record.get("identifier"));sourceComboBox.onSelect(record,index);newSourceWindow.hide();};var failure=function(){newSourceWindow.setError(this.sourceLoadFailureMessage);};this.addSource(url,null,success,failure,this);},this);this.capGrid=new Ext.Window({title:this.capGridText,closeAction:'hide',layout:'border',height:300,width:600,modal:true,items:[capGridPanel],tbar:capGridToolbar,bbar:["->",new Ext.Button({text:this.capGridAddLayersText,iconCls:"icon-addlayers",handler:function(){capGridPanel.addLayers();},scope:this}),new Ext.Button({text:this.capGridDoneText,handler:function(){this.capGrid.hide();},scope:this})],listeners:{hide:function(win){capGridPanel.getSelectionModel().clearSelections();}}});},showCapabilitiesGrid:function(){if(!this.capGrid){this.initCapGrid();}
this.capGrid.show();},createMapOverlay:function(){var scaleLinePanel=new Ext.Panel({cls:'olControlScaleLine overlay-element overlay-scaleline',border:false});scaleLinePanel.on('render',function(){var scaleLine=new OpenLayers.Control.ScaleLine({div:scaleLinePanel.body.dom});this.map.addControl(scaleLine);scaleLine.activate();},this);var zoomStore=new GeoExt.data.ScaleStore({map:this.map});var zoomSelector=new Ext.form.ComboBox({emptyText:this.zoomSelectorText,tpl:'<tpl for="."><div class="x-combo-list-item">1 : {[parseInt(values.scale)]}</div></tpl>',editable:false,triggerAction:'all',mode:'local',store:zoomStore,width:110});zoomSelector.on('click',function(evt){evt.stopEvent();});zoomSelector.on('mousedown',function(evt){evt.stopEvent();});zoomSelector.on('select',function(combo,record,index){this.map.zoomTo(record.data.level);},this);var zoomSelectorWrapper=new Ext.Panel({items:[zoomSelector],cls:'overlay-element overlay-scalechooser',border:false});this.map.events.register('zoomend',this,function(){var scale=zoomStore.queryBy(function(record){return this.map.getZoom()==record.data.level;});if(scale.length>0){scale=scale.items[0];zoomSelector.setValue("1 : "+parseInt(scale.data.scale,10));}else{if(!zoomSelector.rendered)return;zoomSelector.clearValue();}});var mapOverlay=new Ext.Panel({cls:'map-overlay',items:[scaleLinePanel,zoomSelectorWrapper]});mapOverlay.on("afterlayout",function(){scaleLinePanel.body.dom.style.position='relative';scaleLinePanel.body.dom.style.display='inline';mapOverlay.getEl().on("click",function(x){x.stopEvent();});mapOverlay.getEl().on("mousedown",function(x){x.stopEvent();});},this);return mapOverlay;},createTools:function(){var toolGroup="toolGroup";var navAction=new GeoExt.Action({tooltip:this.navActionTipText,iconCls:"icon-pan",enableToggle:true,pressed:true,allowDepress:false,control:new OpenLayers.Control.Navigation(),map:this.map,toggleGroup:toolGroup});var historyControl=new OpenLayers.Control.NavigationHistory();this.map.addControl(historyControl);var navPreviousAction=new GeoExt.Action({tooltip:this.navPreviousActionText,iconCls:"icon-zoom-previous",disabled:true,control:historyControl.previous});var navNextAction=new GeoExt.Action({tooltip:this.navNextAction,iconCls:"icon-zoom-next",disabled:true,control:historyControl.next});var info={controls:[]};var infoButton=new Ext.Button({tooltip:this.infoButtonText,iconCls:"icon-getfeatureinfo",toggleGroup:toolGroup,enableToggle:true,allowDepress:false,toggleHandler:function(button,pressed){for(var i=0,len=info.controls.length;i<len;i++){if(pressed){info.controls[i].activate();}else{info.controls[i].deactivate();}}}});var updateInfo=function(){var queryableLayers=this.mapPanel.layers.queryBy(function(x){return x.get("queryable");});var map=this.mapPanel.map;var control;for(var i=0,len=info.controls.length;i<len;i++){control=info.controls[i];control.deactivate();control.destroy();}
info.controls=[];queryableLayers.each(function(x){var control=new OpenLayers.Control.WMSGetFeatureInfo({url:x.get("layer").url,queryVisible:true,layers:[x.get("layer")],eventListeners:{getfeatureinfo:function(evt){this.displayPopup(evt,x.get("title")||x.get("name"));},scope:this}});map.addControl(control);info.controls.push(control);if(infoButton.pressed){control.activate();}},this);};this.mapPanel.layers.on("update",updateInfo,this);this.mapPanel.layers.on("add",updateInfo,this);this.mapPanel.layers.on("remove",updateInfo,this);var activeIndex=0;var measureSplit=new Ext.SplitButton({iconCls:"icon-measure-length",tooltip:this.measureSplitText,enableToggle:true,toggleGroup:toolGroup,allowDepress:false,handler:function(button,event){if(!button.pressed){button.toggle();}else{button.menu.items.itemAt(activeIndex).setChecked(true);}},listeners:{toggle:function(button,pressed){if(!pressed){button.menu.items.each(function(i){i.setChecked(false);});}},render:function(button){Ext.ButtonToggleMgr.register(button);}},menu:new Ext.menu.Menu({items:[new Ext.menu.CheckItem(new GeoExt.Action({text:this.lengthActionText,iconCls:"icon-measure-length",map:this.map,toggleGroup:toolGroup,group:toolGroup,allowDepress:false,map:this.map,control:this.createMeasureControl(OpenLayers.Handler.Path,"Length")})),new Ext.menu.CheckItem(new GeoExt.Action({text:this.areaActionText,iconCls:"icon-measure-area",map:this.map,toggleGroup:toolGroup,group:toolGroup,allowDepress:false,map:this.map,control:this.createMeasureControl(OpenLayers.Handler.Polygon,"Area")}))]})});measureSplit.menu.items.each(function(item,index){item.on({checkchange:function(item,checked){measureSplit.toggle(checked);if(checked){activeIndex=index;measureSplit.setIconClass(item.iconCls);}}});});var enable3DButton=new Ext.Button({iconCls:"icon-3D",tooltip:this.switchTo3DActionText,enableToggle:true,toggleHandler:function(button,state){if(state===true){this.mapPanelContainer.getLayout().setActiveItem(1);this.toolbar.disable();button.enable();}else{this.mapPanelContainer.getLayout().setActiveItem(0);this.toolbar.enable();}},scope:this});var tools=[new Ext.Button({tooltip:this.saveMapText,handler:this.saveMap,scope:this,iconCls:"icon-save"}),new Ext.Button({handler:function(){this.map.zoomIn();},tooltip:this.zoomInActionText,iconCls:"icon-zoom-in",scope:this}),new Ext.Button({tooltip:this.zoomOutActionText,handler:function(){this.map.zoomOut();},iconCls:"icon-zoom-out",scope:this}),navPreviousAction,navNextAction,new Ext.Button({tooltip:this.zoomVisibleButtonText,iconCls:"icon-zoom-visible",handler:function(){var extent,layer;for(var i=0,len=this.map.layers.length;i<len;++i){layer=this.map.layers[i];if(layer.getVisibility()){if(extent){extent.extend(layer.maxExtent);}else{extent=layer.maxExtent.clone();}}}
if(extent){this.map.zoomToExtent(extent);}},scope:this}),new Ext.Action({tooltip:this.publishActionText,handler:this.makeExportDialog,scope:this,iconCls:'icon-export'}),enable3DButton];return tools;},createMeasureControl:function(handlerType,title){var styleMap=new OpenLayers.StyleMap({"default":new OpenLayers.Style(null,{rules:[new OpenLayers.Rule({symbolizer:{"Point":{pointRadius:4,graphicName:"square",fillColor:"white",fillOpacity:1,strokeWidth:1,strokeOpacity:1,strokeColor:"#333333"},"Line":{strokeWidth:3,strokeOpacity:1,strokeColor:"#666666",strokeDashstyle:"dash"},"Polygon":{strokeWidth:2,strokeOpacity:1,strokeColor:"#666666",fillColor:"white",fillOpacity:0.3}}})]})});var cleanup=function(){if(measureToolTip){measureToolTip.destroy();}};var makeString=function(metricData){var metric=metricData.measure;var metricUnit=metricData.units;measureControl.displaySystem="english";var englishData=metricData.geometry.CLASS_NAME.indexOf("LineString")>-1?measureControl.getBestLength(metricData.geometry):measureControl.getBestArea(metricData.geometry);var english=englishData[0];var englishUnit=englishData[1];measureControl.displaySystem="metric";var dim=metricData.order==2?'<sup>2</sup>':'';return metric.toFixed(2)+" "+metricUnit+dim+"<br>"+
english.toFixed(2)+" "+englishUnit+dim;};var measureToolTip;var measureControl=new OpenLayers.Control.Measure(handlerType,{persist:true,handlerOptions:{layerOptions:{styleMap:styleMap}},eventListeners:{measurepartial:function(event){cleanup();measureToolTip=new Ext.ToolTip({target:Ext.getBody(),html:makeString(event),title:title,autoHide:false,closable:true,draggable:false,mouseOffset:[0,0],showDelay:1,listeners:{hide:cleanup}});if(event.measure>0){var px=measureControl.handler.lastUp;var p0=this.mapPanel.getPosition();measureToolTip.targetXY=[p0[0]+px.x,p0[1]+px.y];measureToolTip.show();}},measure:function(event){cleanup();measureToolTip=new Ext.ToolTip({target:Ext.getBody(),html:makeString(event),title:title,autoHide:false,closable:true,draggable:false,mouseOffset:[0,0],showDelay:1,listeners:{hide:function(){measureControl.cancel();cleanup();}}});},deactivate:cleanup,scope:this}});return measureControl;},makeExportDialog:function(){new ExportWizard({map:this.mapID}).show();},extractConfiguration:function(){var center=this.map.getCenter();var config={wms:{},map:{center:[center.lon,center.lat],zoom:this.map.zoom,layers:[]},about:Ext.apply({},this.about)};this.layerSources.each(function(record){config.wms[record.get("identifier")]=record.get("url");});this.layers.each(function(layerRecord){var layer=layerRecord.get('layer');if(layer.displayInLayerSwitcher){var index=this.layerSources.find("identifier",layerRecord.get("source_id"));var source=this.layerSources.getAt(index);if(source===null){OpenLayers.Console.error("Could not find source for layer '"+layerRecord.get("name")+"'");return;}
config.map.layers.push({name:layerRecord.get("name"),title:layerRecord.get("title"),visibility:layer.getVisibility(),group:layerRecord.get("group"),wms:source.get("identifier")});}},this);return config;},saveMap:function(){var config=this.extractConfiguration();var failure=function(response,options){new Ext.Window({title:this.saveFailTitle,html:this.saveFailMessage}).show();};Ext.Ajax.request({url:this.rest,method:'POST',jsonData:config,success:function(response,options){var id=response.getResponseHeader["Location"];id=id.replace(/^\s*/,'');id=id.replace(/\s*$/,'');this.fireEvent("idchange",id);this.mapID=id;},failure:failure,scope:this});}});Ext.namespace("GeoExplorer");GeoExplorer.util={dispatch:function(functions,complete,scope){complete=complete||Ext.emptyFn;scope=scope||this;var requests=functions.length;var responses=0;var storage={};function respond(){++responses;if(responses===requests){complete.call(scope,storage);}}
function trigger(index){window.setTimeout(function(){functions[index].apply(scope,[respond,storage]);});}
for(var i=0;i<requests;++i){trigger(i);}}};var Page=Ext.extend(Ext.util.Observable,{constructor:function(config){this.initialConfig=config;Ext.apply(this,this.initialConfig);this.addEvents("ready");this.load();},load:function(){GeoExplorer.util.dispatch([function(done){Ext.onReady(function(){this.createLayout();done();},this);}],this.activate,this);},createLayout:function(){this.populateContent();},activate:function(){this.fireEvent("ready");}});var CommunityPage=Ext.extend(Page,{capabilities:null,capGrid:null,constructor:function(config){if(this.proxy){OpenLayers.ProxyHost=this.proxy;}
Page.prototype.constructor.apply(this,arguments);},owsURL:function(params){var argIndex=this.ows.indexOf("?");if(argIndex>-1){var search=this.ows.substring(this.ows.indexOf("?")+1);var url=this.ows.replace(search,Ext.urlEncode(Ext.apply(Ext.urlDecode(search),params)));}else{url=this.ows+"?"+Ext.urlEncode(params);}
if(this.proxy){url=this.proxy+encodeURIComponent(url);}
return url;},createLayout:function(){this.populateContent();this.layers=new GeoExt.data.LayerStore({});},activate:function(){this.initPanel();Ext.QuickTips.init();this.fireEvent("ready");},restURL:function(params){var argIndex=this.rest.indexOf("?");if(argIndex>-1){var search=this.rest.substring(this.rest.indexOf("?")+1);var url=this.ows.replace(search,Ext.urlEncode(Ext.apply(Ext.urlDecode(search),params)));}else{url=this.rest+"?"+Ext.urlEncode(params);}
return url;},initPanel:function(){var mapGrid=new MapGrid({store:new Ext.data.JsonStore({url:this.restURL(),root:'maps',id:'id',fields:[{name:'id',mapping:'id'},{name:"title",mapping:"config.about.title"},{name:"tags",mapping:"config.about.tags"},{name:"abstract",mapping:"config.about.abstract"},{name:"contact",mapping:"config.about.contact"},{name:"featured",mapping:"config.about.featured"}],autoLoad:true,listeners:{"load":function(store){store.filterBy(function(record){return!record.get("featured");});}}})});}});var DataPage=Ext.extend(Page,{capabilities:null,capGrid:null,dataGridText:"UT:Data",mapGridText:"UT:Map",dataNameHeaderText:"UT:Name",dataTitleHeaderText:"UT:Title",dataQueryableHeaderText:"UT:Queryable",createMapText:"UT:Create Map",openMapText:"UT:Open Map",mapTitleLabelText:"UT:Title",mapAbstractLabelText:"UT:Abstract",ameLabelText:'UT: AME File',scenarioLabelText:'UT: Scenario',countryLabelText:'UT: Country',singularFile:'UT: File',pluralFiles:'UT: Files',constructor:function(config){if(this.proxy){OpenLayers.ProxyHost=this.proxy;}
Page.prototype.constructor.apply(this,arguments);},load:function(){GeoExplorer.util.dispatch([function(done){Ext.onReady(function(){this.createLayout();done();},this);},function(done){this.initCapabilities();this.capabilities.load({callback:function(){this.describeLayers(done);},scope:this});}],this.activate,this);},describeLayers:function(done){layerNames=[];this.capabilities.each(function(layer){if(layer.get("queryable")){layerNames.push(layer.get("name"));}});layerNames=layerNames.join(",");var describeLayerStore=new GeoExt.data.WMSDescribeLayerStore({url:this.owsURL({SERVICE:"WMS",REQUEST:"DescribeLayer",VERSION:"1.1.1",layers:layerNames})});var annotateLayers=function(){describeLayerStore.each(function(description){var layer=this.capabilities.getAt(this.capabilities.find("name",description.get("typeName")));layer.set("owsType",description.get("owsType"));},this);done();};describeLayerStore.load({callback:annotateLayers,scope:this});},initCapabilities:function(){var args={SERVICE:"WMS",REQUEST:"GetCapabilities"};var url=this.owsURL(args);this.capabilities=new GeoExt.data.WMSCapabilitiesStore({url:url,fields:[{name:"name",type:"string"},{name:"abstract",type:"string"},{name:"queryable",type:"boolean"},{name:"formats"},{name:"styles"},{name:"llbbox"},{name:"minScale"},{name:"maxScale"},{name:"prefix"},{name:"attribution"},{name:"keywords"},{name:"metadataURLs"},{name:"owsType"}]});},owsURL:function(params){var argIndex=this.ows.indexOf("?");if(argIndex>-1){var search=this.ows.substring(this.ows.indexOf("?")+1);var url=this.ows.replace(search,Ext.urlEncode(Ext.apply(Ext.urlDecode(search),params)));}else{url=this.ows+"?"+Ext.urlEncode(params);}
if(this.proxy){url=this.proxy+encodeURIComponent(url);}
return url;},createLayout:function(){this.layers=new GeoExt.data.LayerStore({});},activate:function(){this.initPanel();Ext.QuickTips.init();this.fireEvent("ready");},initPanel:function(){var riskExpander=new GeoExplorer.CapabilitiesRowExpander({ows:this.ows});var overlayExpander=new GeoExplorer.CapabilitiesRowExpander({ows:this.ows});var riskStore=new Ext.data.SimpleStore({fields:this.capabilities.fields});this.capabilities.each(function(record){if(record.get("prefix")=="risk")riskStore.add([record]);});var overlayStore=new Ext.data.SimpleStore({fields:this.capabilities.fields});this.capabilities.each(function(record){if(record.get("prefix")=="overlay")overlayStore.add([record]);});var ameStore=new Ext.data.GroupingStore({proxy:new Ext.data.HttpProxy({url:this.url+"/www/out.json"}),reader:new Ext.data.JsonReader({fields:['rel_tifs','path','scenario','country']}),groupField:'scenario',sortInfo:{field:'scenario',direction:'ASC'},groupOnSort:true,autoLoad:true});var ows=this.ows,ame_link_prefix=this.ame_link_prefix;var templateLib={ows:function(){return ows;},expanderContent:function(relTifs){if(relTifs.length<1){return"i18n!! No associated layer files";}else{var content="i18n!! Associated layer files (as GeoTiff): ";var links=[];for(var i=0;i<relTifs.length;i++){links.push("<a href='"
+this.geoTiffUrl(relTifs[i].replace(".grd",""))
+"'>"
+relTifs[i].replace(/.*\//,"")
+"</a>");}
content=content+links.join(", ");return content;}},geoTiffUrl:function(path,values){return ame_link_prefix+"/"+path;}}
var ameExpander=new Ext.grid.RowExpander({tpl:Ext.apply(new Ext.Template('{rel_tifs:this.expanderContent}'),templateLib)});this.riskCapGrid=new Ext.grid.GridPanel({renderTo:"risk-layer-browser",store:riskStore,autoScroll:true,height:200,alignToGrid:this.alignToGrid,plugins:riskExpander,cm:new Ext.grid.ColumnModel([riskExpander,{id:"title",header:this.dataTitleHeaderText,dataIndex:"title",sortable:true},{header:this.dataNameHeaderText,dataIndex:"name",width:180,sortable:true}]),viewConfig:{autoFill:true},sm:new Ext.grid.RowSelectionModel({singleSelect:true})});this.overlayCapGrid=new Ext.grid.GridPanel({renderTo:"overlay-layer-browser",store:overlayStore,autoScroll:true,height:200,alignToGrid:this.alignToGrid,plugins:overlayExpander,cm:new Ext.grid.ColumnModel([overlayExpander,{id:"title",header:this.dataTitleHeaderText,dataIndex:"title",sortable:true},{header:this.dataNameHeaderText,dataIndex:"name",width:180,sortable:true}]),viewConfig:{autoFill:true},sm:new Ext.grid.RowSelectionModel({singleSelect:true})});this.ameGrid=new Ext.grid.GridPanel({renderTo:'ame-layer-browser',store:ameStore,plugins:[ameExpander],columns:[ameExpander,{id:'path',header:this.ameLabelText,dataIndex:'path',renderer:function(x){return'<a href="'+ame_link_prefix+'/'+x+'">'+x.replace(/.*\//,'')+'</a';}},{header:this.scenarioLabelText,dataIndex:'scenario'},{header:this.countryLabelText,dataIndex:'country'}],height:200,view:new Ext.grid.GroupingView({forceFit:true,groupTextTpl:'{text} ({[values.rs.length]} '+'{[values.rs.length > 1 ? "'+this.singularFile+'" : "'+this.pluralFiles+'"]})'}),viewConfig:{autoFill:true}});}});var DeveloperPage=Ext.extend(Page,{});Embed=Ext.extend(GeoExplorer,{zoomLevelText:"UT:Zoom Level: {zoom}",useToolbar:true,createLayout:function(){this.map=new OpenLayers.Map({allOverlays:true,controls:[new OpenLayers.Control.PanPanel(),new OpenLayers.Control.ZoomPanel()]});var onDoubleClick=function(ctrl,evt){OpenLayers.Event.stop(evt?evt:window.event);};var controls=this.map.controls[0].controls;for(var i=0;i<controls.length;i++){OpenLayers.Event.observe(controls[i].panel_div,"dblclick",OpenLayers.Function.bind(onDoubleClick,this.map.controls[0],controls[i]));}
this.map.events.on({"preaddlayer":function(evt){if(evt.layer.mergeNewParams){var maxExtent=evt.layer.maxExtent;evt.layer.mergeNewParams({transparent:true,format:"image/png",tiled:true,tilesorigin:[maxExtent.left,maxExtent.bottom]});}},scope:this});var mapConfig=this.initialConfig.map||{};this.mapPanel=new GeoExt.MapPanel({layout:"anchor",border:true,region:"center",map:this.map,center:mapConfig.center&&new OpenLayers.LonLat(mapConfig.center[0],mapConfig.center[1]),zoom:mapConfig.zoom,items:[{xtype:"gx_zoomslider",vertical:true,height:100,plugins:new GeoExt.ZoomSliderTip({template:"<div>"+this.zoomLevelText+"</div>"})},this.createMapOverlay()]});this.layers=this.mapPanel.layers;var toolbar;if(this.useToolbar){toolbar=new Ext.Toolbar({xtype:"toolbar",region:"north",disabled:true,items:this.createTools()});this.on("ready",function(){toolbar.enable();});}else{this.mapPanel.map.addControl(new OpenLayers.Control.Navigation());}
var viewport=new Ext.Viewport({layout:"fit",hideBorders:true,items:{layout:"border",deferredRender:false,items:(toolbar?[toolbar]:[]).concat([this.mapPanel])}});},createTools:function(){var tools=Embed.superclass.createTools.apply(this,arguments);var menu=new Ext.menu.Menu();var updateLayerSwitcher=function(){menu.removeAll();menu.getEl().addClass("gx-layer-menu");menu.getEl().applyStyles({width:'',height:''});menu.add({iconCls:"gx-layer-visibility",text:"Layer",canActivate:false},"-");this.mapPanel.layers.each(function(record){var layer=record.get("layer");if(layer.displayInLayerSwitcher){var item=new Ext.menu.CheckItem({text:record.get("title"),checked:record.get("layer").getVisibility(),group:record.get("group"),listeners:{checkchange:function(item,checked){record.get("layer").setVisibility(checked);}}});if(menu.items.getCount()>2){menu.insert(2,item);}else{menu.add(item);}}});};this.mapPanel.layers.on("add",updateLayerSwitcher,this);var layerChooser=new Ext.Button({tooltip:this.layerContainerText,iconCls:'icon-layer-switcher',menu:menu});tools.unshift("-");tools.unshift(layerChooser);return tools;}});var ExportWizard=Ext.extend(Ext.Window,{exportDialogMessage:'<p> UT: Your map is ready to be published to the web! </p>'+'<p> Simply copy the following HTML to embed the map in your website: </p>',publishActionText:'UT:Publish Map',heightLabel:'UT: Height',widthLabel:'UT: Width',mapSizeLabel:'UT: Map Size',miniSizeLabel:'UT: Mini',smallSizeLabel:'UT: Small',largeSizeLabel:'UT: Large',premiumSizeLabel:'UT: Premium',initComponent:function(config){var description=new Ext.Panel({cls:'gx-wizard-description',html:this.exportDialogMessage,border:false});var snippetArea=new Ext.form.TextArea({height:'100',selectOnFocus:true,enableKeyEvents:true,listeners:{keypress:function(area,evt){evt.stopEvent();}}});var heightField=new Ext.form.NumberField({width:50,value:400});var widthField=new Ext.form.NumberField({width:50,value:600});var updateSnippet=function(){var query=Ext.urlEncode({map:this.map});var pathname=window.location.pathname.replace(/\/[^\/]*$/,'/embed.html');var url=window.location.protocol+"//"+
window.location.host+
pathname+"?"+query;snippetArea.setValue('<iframe height="'+heightField.getValue()+' " width="'+widthField.getValue()+'" src="'+url+'"> </iframe>');};heightField.on("change",updateSnippet,this);widthField.on("change",updateSnippet,this);var snippet=new Ext.Panel({border:false,layout:'fit',cls:'gx-snippet-area',items:[snippetArea]});var adjustments=new Ext.Panel({layout:"column",items:[new Ext.Panel({border:false,width:90,items:[new Ext.form.ComboBox({editable:false,width:70,store:new Ext.data.SimpleStore({fields:["name","height","width"],data:[[this.miniSizeLabel,100,100],[this.smallSizeLabel,200,300],[this.largeSizeLabel,400,600],[this.premiumSizeLabel,600,800]]}),triggerAction:'all',displayField:'name',value:this.largeSizeLabel,mode:'local',listeners:{'select':function(combo,record,index){widthField.setValue(record.get("width"));heightField.setValue(record.get("height"));updateSnippet.call(this);},scope:this}})]}),{cls:'gx-field-label',html:this.heightLabel,border:false},heightField,{cls:'gx-field-label',html:this.widthLabel,border:false},widthField],border:false});Ext.apply(this,{cls:'gx-wizard-pane',border:false,modal:true,title:this.publishActionText,height:'auto',width:500,items:[description,snippet,{cls:'gx-field-label',html:this.mapSizeLabel,border:false},adjustments]});ExportWizard.superclass.initComponent.call(this);this.on('show',updateSnippet);}});var FeaturedPage=Ext.extend(Page,{capabilities:null,capGrid:null,constructor:function(config){if(this.proxy){OpenLayers.ProxyHost=this.proxy;}
Page.prototype.constructor.apply(this,arguments);},owsURL:function(params){var argIndex=this.ows.indexOf("?");if(argIndex>-1){var search=this.ows.substring(this.ows.indexOf("?")+1);var url=this.ows.replace(search,Ext.urlEncode(Ext.apply(Ext.urlDecode(search),params)));}else{url=this.ows+"?"+Ext.urlEncode(params);}
if(this.proxy){url=this.proxy+encodeURIComponent(url);}
return url;},createLayout:function(){this.populateContent();this.layers=new GeoExt.data.LayerStore({});},activate:function(){this.initPanel();Ext.QuickTips.init();this.fireEvent("ready");},restURL:function(params){var argIndex=this.rest.indexOf("?");if(argIndex>-1){var search=this.rest.substring(this.rest.indexOf("?")+1);var url=this.ows.replace(search,Ext.urlEncode(Ext.apply(Ext.urlDecode(search),params)));}else{url=this.rest+"?"+Ext.urlEncode(params);}
return url;},initPanel:function(){var mapGrid=new MapGrid({store:new Ext.data.JsonStore({url:this.restURL(),root:'maps',id:'id',fields:[{name:'id',mapping:'id'},{name:"title",mapping:"config.about.title"},{name:"tags",mapping:"config.about.tags"},{name:"abstract",mapping:"config.about.abstract"},{name:"contact",mapping:"config.about.contact"},{name:"featured",mapping:"config.about.featured"}],autoLoad:true,listeners:{"load":function(store){store.filter("featured",true);}}})});}});var HelpPage=Ext.extend(Page,{});var IndexPage=Ext.extend(Page,{});Lang={registerLinks:function(){var languages={'#spanish':'es','#english':'en'};for(var id in languages){var domNode=Ext.DomQuery.selectNode(id);if(domNode){domNode.onclick=(function(langcode){return function(){(new Ext.state.CookieProvider).set("locale",langcode);window.location.reload();return false;};})(languages[id]);}}}};Ext.onReady(Lang.registerLinks);Ext.namespace("GeoExplorer");GeoExplorer.GoogleEarthPanel=Ext.extend(Ext.Panel,{HORIZONTAL_FIELD_OF_VIEW:(30*Math.PI)/180,map:null,mapPanel:null,layers:null,earth:null,projection:null,layerCache:null,initComponent:function(){GeoExplorer.GoogleEarthPanel.superclass.initComponent.call(this);if(!this.map){this.map=this.mapPanel&&this.mapPanel.map;}
if(!this.layers){this.layers=this.mapPanel&&this.mapPanel.layers;}
this.projection=new OpenLayers.Projection("EPSG:4326");this.on("show",function(){this.layerCache={};google.earth.createInstance(this.body.dom,this.onEarthReady.createDelegate(this),function(){});},this);this.on("hide",function(){if(this.earth!=null){this.updateMap();this.body.child("*").remove();}
this.earth=null;},this);},onEarthReady:function(object){this.earth=object;this.earth.getOptions().setFlyToSpeed(this.earth.SPEED_TELEPORT);this.resetCamera();this.setExtent(this.map.getExtent());this.earth.getNavigationControl().setVisibility(this.earth.VISIBILITY_SHOW);var screenXY=this.earth.getNavigationControl().getScreenXY();screenXY.setXUnits(this.earth.UNITS_PIXELS);screenXY.setYUnits(this.earth.UNITS_INSET_PIXELS);this.earth.getWindow().setVisibility(true);this.layers.each(function(record){this.addLayer(record);},this);this.layers.on("remove",this.updateLayers,this);this.layers.on("update",this.updateLayers,this);this.layers.on("add",this.updateLayers,this);},updateLayers:function(){if(!this.earth)return;var features=this.earth.getFeatures();var f=features.getFirstChild();while(f!=null){features.removeChild(f);f=features.getFirstChild();}
this.layers.each(function(record){this.addLayer(record);},this);},addLayer:function(layer,order){if(this.earth){var name=layer.get("layer").id;if(this.layerCache[name]){var networkLink=this.layerCache[name];}else{var link=this.earth.createLink('kl_'+name);var ows=layer.get("layer").url;ows=ows.replace(/\?.*/,'');var kmlPath='/kml?mode=refresh&layers='+layer.get("layer").params.LAYERS;link.setHref(ows+kmlPath);var networkLink=this.earth.createNetworkLink('nl_'+name);networkLink.setName(name);networkLink.set(link,false,false);this.layerCache[name]=networkLink;}
networkLink.setVisibility(layer.get("layer").getVisibility());if(order!==undefined&&order<this.earth.getFeatures().getChildNodes().getLength())
{this.earth.getFeatures().insertBefore(this.earth.getFeatures().getChildNodes().item(order));}else{this.earth.getFeatures().appendChild(networkLink);}}},setExtent:function(extent){var extent=extent.transform(this.map.getProjectionObject(),this.projection);var center=extent.getCenterLonLat();var width=this.getExtentWidth(extent);var height=width/(2*Math.tan(this.HORIZONTAL_FIELD_OF_VIEW));var lookAt=this.earth.getView().copyAsLookAt(this.earth.ALTITUDE_RELATIVE_TO_GROUND);lookAt.setLatitude(center.lat);lookAt.setLongitude(center.lon);lookAt.setRange(height);this.earth.getView().setAbstractView(lookAt);},resetCamera:function(){var camera=this.earth.getView().copyAsCamera(this.earth.ALTITUDE_RELATIVE_TO_GROUND);camera.setRoll(0);camera.setHeading(0);camera.setTilt(0);this.earth.getView().setAbstractView(camera);},getExtent:function(){var geBounds=this.earth.getView().getViewportGlobeBounds();var olBounds=new OpenLayers.Bounds(geBounds.getWest(),geBounds.getSouth(),geBounds.getEast(),geBounds.getNorth());return olBounds;},updateMap:function(){var lookAt=this.earth.getView().copyAsLookAt(this.earth.ALTITUDE_RELATIVE_TO_GROUND);var center=this.reprojectToMap(new OpenLayers.LonLat(lookAt.getLongitude(),lookAt.getLatitude()));var geExtent=this.reprojectToMap(this.getExtent());this.map.zoomToExtent(geExtent,true);this.map.setCenter(center);var lookAt=this.earth.getView().copyAsLookAt(this.earth.ALTITUDE_RELATIVE_TO_GROUND);var height=lookAt.getRange();var width=2*height*Math.tan(this.HORIZONTAL_FIELD_OF_VIEW);var nextResolution=this.map.getResolutionForZoom(this.map.getZoom()+1);var currentExtent=this.map.getExtent();var nextExtent=new OpenLayers.Bounds(center.lon-(this.map.getSize().w/2*nextResolution),center.lat+(this.map.getSize().h/2*nextResolution),center.lon+(this.map.getSize().w/2*nextResolution),center.lat-(this.map.getSize().h/2*nextResolution));var currentWidthDiff=Math.abs(this.getExtentWidth(currentExtent)-width);var nextWidthDiff=Math.abs(this.getExtentWidth(nextExtent)-width);if(nextWidthDiff<currentWidthDiff){this.map.zoomTo(this.map.getZoom()+1);}},getExtentWidth:function(extent){var center=extent.getCenterLonLat();var middleLeft=new OpenLayers.LonLat(extent.left,center.lat);var middleRight=new OpenLayers.LonLat(extent.right,center.lat);return OpenLayers.Util.distVincenty(middleLeft,middleRight)*1000;},reprojectToGE:function(data){return data.clone().transform(this.map.getProjectionObject(),this.projection);},reprojectToMap:function(data){return data.clone().transform(this.projection,this.map.getProjectionObject());}});Ext.namespace("GeoExplorer");GeoExplorer.CapabilitiesRowExpander=Ext.extend(Ext.grid.RowExpander,{ows:null,abstractText:"UT:Abstract:",downloadText:"UT:Download:",metadataText:"UT:Metadata Links:",keywordText:"UT:Keywords:",attributionText:"UT:Provided by:",metadataEmptyText:'UT: No metadata URLs are defined for this layer.',keywordEmptyText:"UT: No keywords are listed for this layer.",attributionEmptyText:"UT: No attribution information is provided for this layer.",constructor:function(config){config.tpl=new Ext.Template('<p><b>'+this.abstractText+'</b> {abstract}</p>'+'<p><b>'+this.attributionText+'</b> {attribution:this.attributionLink}</p>'+'<p><b>'+this.metadataText+'</b> {metadataURLs:this.metadataLinks}</p>'+'<p><b>'+this.keywordText+'</b> {keywords:this.keywordList}</p>'+'<p><b>'+this.downloadText+'</b> '+'<a class="download pdf" href="{name:this.pdfUrl}">PDF</a>, '+'<a class="download kml" href="{name:this.kmlUrl}">KML</a>, '+'<a class="download geotiff" href="{name:this.geoTiffUrl}">GeoTIFF</a>'+'<span class="{owsType:this.showWFS}">, '+'<a class="download shp" href="{name:this.shpUrl}">SHP (ZIP)</a>'+'</span>'+'</p>');var expander,templateLib;expander=this;this.ows=config.ows;templateLib=Ext.apply({ows:function(){return expander.ows;}},this.templateLibrary);templateLib.metadataEmptyText=this.metadataEmptyText;templateLib.keywordEmptyText=this.keywordEmptyText;templateLib.attributionEmptyText=this.attributionEmptyText;Ext.apply(config.tpl,templateLib);GeoExplorer.CapabilitiesRowExpander.superclass.constructor.call(this,config);},templateLibrary:{wmsParams:function(name,values,aspect){aspect=aspect||(8.5/11);var dx,dy,dataAspect,widthAdjust,heightAdjust;dx=values.llbbox[2]-values.llbbox[0];dy=values.llbbox[3]-values.llbbox[1];dataAspect=dx/dy;widthAdjust=1;heightAdjust=1;if(dataAspect>aspect){heightAdjust=dataAspect/aspect;}else{widthAdjust=aspect/dataAspect;}
return{service:"wms",request:"GetMap",bbox:this.adjustBounds(widthAdjust,heightAdjust,values.llbbox).toString(),layers:name,srs:"EPSG:4326",width:425,height:550};},adjustBounds:function(widthAdjust,heightAdjust,bbox){var dx,dy,midx,midy;dx=bbox[2]-bbox[0];dy=bbox[3]-bbox[1];midx=(bbox[2]+bbox[0])/2;midy=(bbox[3]+bbox[1])/2;return[midx-(widthAdjust*dx)/2,midy-(heightAdjust*dy)/2,midx+(widthAdjust*dx)/2,midy+(heightAdjust*dy)/2];},wfsParams:function(name,values){return{service:"wfs",request:"GetFeature",typeName:name};},showWFS:function(owsType,values){return owsType==="WFS"?"":"nodisplay";},shpUrl:function(name,values){var shpParams=Ext.apply(this.wfsParams(name,values),{outputFormat:'SHAPE-ZIP'});return this.ows()+"?"+Ext.urlEncode(shpParams);},pdfUrl:function(name,values){var pdfParams=Ext.apply(this.wmsParams(name,values),{format:'application/pdf'});return this.ows()+"?"+Ext.urlEncode(pdfParams);},kmlUrl:function(name,values){var kmlParams=Ext.apply(this.wmsParams(name,values),{format:'application/vnd.google-earth.kmz+xml',height:2048,width:2048},1);return this.ows()+"?"+Ext.urlEncode(kmlParams);},geoTiffUrl:function(name,values){var geoTiffParams=Ext.apply(this.wmsParams(name,values),{format:"image/geotiff"});return this.ows()+"?"+Ext.urlEncode(geoTiffParams);},metadataLinks:function(metadataURLs,values){if(metadataURLs===null||metadataURLs.length===0)
{return"<em>"+this.metadataEmptyText+"</em>";}else{var i,links,len;links=[];for(i=0,len=metadataURLs.length;i<len;i++){links.push("<a href=\""+metadataURLs[i].href+"\"> "+
metadataURLs[i].type+"</a>");}
return links.join(", ");}},keywordList:function(keywords,values){if(keywords===null||keywords.length===0)
{return"<em>"+this.keywordEmptyText+"</em>";}else{return keywords.join(", ");}},attributionLink:function(attribution,values){if(attribution==null||attribution.href==null){return"<em>"+this.attributionEmptyText+"</em>";}else{return"<a href=\""+attribution.href+"\"> "+attribution.title+"</a>";}}}});var MapGrid=Ext.extend(Ext.grid.GridPanel,{url:null,autoScroll:true,autoExpandColumn:'title',renderTo:"map-browser",height:300,mapGridText:"UT:Map",createMapText:"UT:Create Map",openMapText:"UT:Open Map",exportMapText:"UT: Export Map",mapTitleLabelText:"UT:Title",mapAbstractLabelText:"UT:Abstract",mapContactLabelText:"UT:Contact",mapTagsLabelText:"UT:Tags",mapLinkLabelText:"UT:View this Map",initComponent:function(){this.title=this.mapGridText;this.store=this.store||new Ext.data.JsonStore({url:this.url,root:'maps',id:'id',fields:[{name:'id',mapping:'id'},{name:"title",mapping:"config.about.title"},{name:"tags",mapping:"config.about.tags"},{name:"abstract",mapping:"config.about.abstract"},{name:"contact",mapping:"config.about.contact"}],autoLoad:true});if(!this.expander){var tpl=new Ext.Template('<p><b>'+this.mapAbstractLabelText+':</b> {abstract}</p>'+'<p><b>'+this.mapTagsLabelText+':</b> {tags} </p>'+'<p><a href="map.html?map={id}">'+this.mapLinkLabelText+'</a></p>');this.expander=new Ext.grid.RowExpander({tpl:tpl});}
if(!this.plugins){this.plugins=this.expander;}
if(!this.cm){this.cm=new Ext.grid.ColumnModel([this.expander,{id:'title',header:this.mapTitleLabelText,dataIndex:'title',sortable:true},{id:'contact',header:this.mapContactLabelText,dataIndex:'contact',width:250,sortable:true}])}
var mapGrid=this;this.tbar=["->",new Ext.Button({text:this.openMapText,iconCls:"icon-open-map",handler:function(){var rec=mapGrid.getSelectionModel().getSelected();if(rec)
location.href="map.html?"+Ext.urlEncode({map:rec.id});}}),new Ext.Button({text:this.exportMapText,iconCls:"icon-export",handler:function(){var rec=mapGrid.getSelectionModel().getSelected();if(rec)mapGrid.showExportWizard({map:rec.id});}}),new Ext.Button({text:this.createMapText,iconCls:"icon-create-map",handler:function(){location.href="map.html"}})],this.listeners=Ext.applyIf(this.listeners||{},{"rowdblclick":function(grid,rowIndex,evt){var rec=grid.store.getAt(rowIndex);if(rec!=null){location.href="map.html?"+Ext.urlEncode({map:rec.id});}}});MapGrid.superclass.initComponent.call(this);},showExportWizard:function(mapid){new ExportWizard(mapid).show();}});Ext.namespace("GeoExplorer");GeoExplorer.CapabilitiesGrid=Ext.extend(Ext.grid.GridPanel,{store:null,cm:null,expander:null,mapPanel:null,url:null,autoExpandColumn:"title",nameHeaderText:"UT:Name",titleHeaderText:"UT:Title",queryableHeaderText:"UT:Queryable",initComponent:function(){if(!this.store){this.store=new GeoExt.data.WMSCapabilitiesStore({url:this.url+"?service=wms&request=GetCapabilities"});this.store.load();}
if(!this.expander){this.expander=new Ext.grid.RowExpander({tpl:new Ext.Template('<p><b>Abstract:</b> {abstract}</p>')});}
if(!this.plugins){this.plugins=this.expander;}
if(!this.cm){this.cm=new Ext.grid.ColumnModel([this.expander,{id:"title",header:this.titleHeaderText,dataIndex:"title",sortable:true},{header:this.nameHeaderText,dataIndex:"name",width:180,sortable:true},{header:this.queryableHeaderText,dataIndex:"queryable"}]);}
GeoExplorer.CapabilitiesGrid.superclass.initComponent.call(this);},addLayers:function(base){var sm=this.getSelectionModel();var records=sm.getSelections();var record,layer,newRecords=[];for(var i=0;i<records.length;i++){Ext.data.Record.AUTO_ID++;record=records[i].copy(Ext.data.Record.AUTO_ID);layer=record.get("layer").clone();record.set("layer",null);record.set("layer",layer);layer.restrictedExtent=OpenLayers.Bounds.fromArray(record.get("llbbox"));if(this.alignToGrid){layer.maxExtent=new OpenLayers.Bounds(-180,-90,180,90);}else{layer.maxExtent=layer.restrictedExtent;}
newRecords.push(record);}
if(newRecords.length){var index=this.mapPanel.layers.findBy(function(r){return r.get("layer")instanceof OpenLayers.Layer.Vector;});if(index!==-1){this.mapPanel.layers.insert(index,newRecords);}else{this.mapPanel.layers.add(newRecords);}}}});Ext.namespace("GeoExplorer");GeoExplorer.GroupContainer=Ext.extend(GeoExt.tree.LayerContainer,{constructor:function(config){config.text=config.text||"Layers";this.group=config.group;GeoExplorer.GroupContainer.superclass.constructor.apply(this,arguments);this.on({insert:this.onChildAdd,append:this.onChildAdd,scope:this});},render:function(bulkRender){var first=!this.rendered;GeoExplorer.GroupContainer.superclass.render.call(this,bulkRender);if(first){this.layerStore.on({update:this.onStoreUpdate,scope:this});}},onStoreAdd:function(store,records,index){GeoExplorer.GroupContainer.superclass.onStoreAdd.apply(this,arguments);if(this.defaults&&this.defaults.checkedGroup&&!this._reordering){Ext.each(records,function(record){this.enforceOneVisible(record);},this);}},onStoreRemove:function(store,record,index){GeoExplorer.GroupContainer.superclass.onStoreRemove.apply(this,arguments);if(this.defaults&&this.defaults.checkedGroup&&!this._reordering){var layer=this.lastChild&&this.lastChild.layer;if(layer){var last;this.layerStore.each(function(rec){if(rec.get("layer")===layer){last=rec;}
return!last;});if(last){this.enforceOneVisible(last);}}}},onStoreUpdate:function(store,record,operation){if(this.defaults&&this.defaults.checkedGroup){this.enforceOneVisible(record);}},enforceOneVisible:function(record){var layer=record.get("layer");var inGroup=false;this.eachChild(function(node){if(node.layer===layer){inGroup=true;}
return!inGroup;});if(inGroup){var vis=layer.getVisibility();if(vis){this.eachChild(function(node){if(node.layer!==layer&&node.layer.getVisibility()){window.setTimeout(function(){node.layer.setVisibility(false);},0);}});}else{this.eachChild(function(node){vis=vis||node.layer.getVisibility();});if(!vis){window.setTimeout(function(){record.get("layer").setVisibility(true);},0);}}}},addLayerNode:function(layerRecord,index){if(layerRecord.get("group")==this.group){GeoExplorer.GroupContainer.superclass.addLayerNode.apply(this,arguments);}},removeLayerNode:function(layerRecord){if(layerRecord.get("group")==this.group){GeoExplorer.GroupContainer.superclass.removeLayerNode.apply(this,arguments);}},recordIndexToNodeIndex:function(index){var store=this.layerStore;var count=store.getCount();var nodeCount=this.childNodes.length;var nodeIndex=-1;var record;for(var i=count-1;i>=0;--i){record=store.getAt(i);if(record.get("layer").displayInLayerSwitcher&&record.get("group")==this.group){++nodeIndex;if(index===i||nodeIndex>nodeCount-1){break;}}};return nodeIndex;},nodeIndexToRecordIndex:function(index){var store=this.layerStore;var count=store.getCount();var nodeIndex=-1;var layer=this.item(index).layer;var record;for(var i=count-1;i>=0;--i){record=store.getAt(i);if(layer.displayInLayerSwitcher&&(record.get("group")==this.group)){++nodeIndex;if(index===nodeIndex){break;}}}
return i;},onChildAdd:function(tree,container,node){var record=this.layerStore.getAt(this.layerStore.findBy(function(record){return record.get("layer")===node.layer;}));if(record.get("group")!==this.group){window.setTimeout(function(){var store=container.layerStore;var index=container.indexOf(node);store.remove(record);node.remove();Ext.data.Record.AUTO_ID++;record=record.copy(Ext.data.Record.AUTO_ID);var layer=record.get("layer").clone();record.set("layer",null);record.set("layer",layer);record.set("group",container.group);if(container.childNodes.length==0){if(tree.root.firstChild===container){store.add([record]);}else{store.insert(0,[record]);}}else{var sib=container.childNodes[index];var offset=1;if(!sib){offset=0;sib=container.lastChild;}
var recIndex=store.findBy(function(rec){return(rec.get("layer")===sib.layer);})+offset;store.insert(recIndex,[record]);}},0);}},destroy:function(){if(this.layerStore){this.layerStore.un("update",this.onStoreUpdate,this);}
GeoExplorer.GroupContainer.superclass.destroy.apply(this,arguments);}});Ext.namespace("GeoExplorer");GeoExplorer.NewSourceWindow=Ext.extend(Ext.Window,{title:"Add New Server...",bodyStyle:"padding: 0px",width:300,closeAction:'hide',error:null,initComponent:function(){this.addEvents("server-added");this.urlTextField=new Ext.form.TextField({fieldLabel:"URL",width:240,msgTarget:"under",validator:OpenLayers.Function.bind(function(){return(this.error==null)?true:this.error;},this)});this.form=new Ext.form.FormPanel({items:[this.urlTextField],border:false,labelWidth:30,bodyStyle:"padding: 5px",autoWidth:true,autoHeight:true});this.bbar=[new Ext.Button({text:"Cancel",handler:function(){this.hide();},scope:this}),new Ext.Toolbar.Fill(),new Ext.Button({text:"Add Server",iconCls:"icon-addlayers",handler:function(){this.error=null;this.urlTextField.validate();this.fireEvent("server-added",this.urlTextField.getValue());},scope:this})];this.items=this.form;GeoExplorer.NewSourceWindow.superclass.initComponent.call(this);this.form.on("render",function(){this.loadMask=new Ext.LoadMask(this.form.getEl(),{msg:"Contacting Server..."});},this);this.on("hide",function(){this.error=null;this.urlTextField.validate();this.urlTextField.setValue("");this.loadMask.hide();},this);},setLoading:function(){this.loadMask.show();},setError:function(error){this.loadMask.hide();this.error=error;this.urlTextField.validate();}});